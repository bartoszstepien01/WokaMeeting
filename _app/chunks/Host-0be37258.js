import{e as r,P as d}from"./index-358da7be.js";import"./vendor-ae9d1f21.js";class m extends r.exports.EventEmitter{constructor(a,t){super();this.peers={},this.videoEnabled=!0,this.audioEnabled=!0,this.username=a,this.stream=t,this.peer=new d(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}),this.peer.on("open",e=>{this.id=e,this.emit("open",e)}),this.peer.on("call",e=>{e.peer in this.peers?this.peers[e.peer].media=e:this.peers[e.peer]={username:e.metadata.username,media:e,conn:void 0},e.answer(t),e.on("stream",s=>{this.emit("peer",{id:e.peer,username:e.metadata.username,stream:s,video:e.metadata.video,audio:e.metadata.audio})})}),this.peer.on("connection",e=>{e.peer in this.peers?this.peers[e.peer].conn=e:this.peers[e.peer]={username:e.metadata.username,media:void 0,conn:e},e.on("open",()=>{Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.peer!=e.peer&&s.send({type:"connect",data:{peerId:e.peer,username:this.peers[e.peer].username}})}),e.send({type:"initialization",data:{username:a,video:this.videoEnabled,audio:this.audioEnabled}})}),e.on("close",()=>{delete this.peers[e.peer],Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.send({type:"disconnect",data:{peerId:e.peer}})}),this.emit("disconnect",e.peer)}),e.on("data",s=>{switch(s.type){case"message":this.emit("message",{author:this.peers[e.peer].username,message:s.data.message,id:e.peer,me:!1}),Object.values(this.peers).map(i=>i.conn).forEach(i=>{i.peer!=e.peer&&i.send({type:"message",data:{author:this.peers[e.peer].username,message:s.data.message,id:e.peer}})});break;case"toggle":this.emit("toggle",{id:e.peer,video:s.data.video,audio:s.data.audio}),Object.values(this.peers).map(i=>i.conn).forEach(i=>{i.peer!=e.peer&&i.send({type:"toggle",data:{id:e.peer,video:s.data.video,audio:s.data.audio}})});break}}),window.onunload=window.onbeforeunload=()=>{e.close()}})}send(a){this.emit("message",{author:this.username,message:a,id:this.id,me:!0}),Object.values(this.peers).map(t=>t.conn).forEach(t=>{t.send({type:"message",data:{author:this.username,message:a,id:this.id}})})}replaceStream(a){let t=a.getVideoTracks()[0];this.stream.getVideoTracks().forEach(e=>{e.stop(),this.stream.removeTrack(e)}),this.stream.addTrack(t),Object.values(this.peers).map(e=>e.media).forEach(e=>{e.peerConnection.getSenders().filter(s=>s.track.kind=="video").forEach(s=>s.replaceTrack(t))})}toggleMedia(a=this.videoEnabled,t=this.audioEnabled){this.videoEnabled=a,this.audioEnabled=t,Object.values(this.peers).map(e=>e.conn).forEach(e=>{e.send({type:"toggle",data:{id:this.peer.id,video:a,audio:t}})})}}export{m as default};
