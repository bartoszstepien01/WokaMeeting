import{e as i,P as p}from"./index-d400411c.js";import"./vendor-f7df6e26.js";class o extends i.exports.EventEmitter{constructor(t,r){super();this.peers={},this.username=t,this.stream=r,this.peer=new p(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}),this.peer.on("open",e=>{this.id=e,this.emit("open",e)}),this.peer.on("call",e=>{e.peer in this.peers?this.peers[e.peer].media=e:this.peers[e.peer]={username:e.metadata.username,media:e,conn:void 0},e.answer(r),e.on("stream",s=>{this.emit("peer",{id:e.peer,username:e.metadata.username,stream:s})})}),this.peer.on("connection",e=>{e.peer in this.peers?this.peers[e.peer].conn=e:this.peers[e.peer]={username:e.metadata.username,media:void 0,conn:e},e.on("open",()=>{Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.peer!=e.peer&&s.send({type:"connect",data:{peerId:e.peer,username:this.peers[e.peer].username}})}),e.send({type:"username",data:{username:t}})}),e.on("close",()=>{delete this.peers[e.peer],Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.send({type:"disconnect",data:{peerId:e.peer}})}),this.emit("disconnect",e.peer)}),e.on("data",s=>{switch(s.type){case"message":this.emit("message",{author:this.peers[e.peer].username,message:s.data.message,id:e.peer,me:!1}),Object.values(this.peers).map(a=>a.conn).forEach(a=>{a.peer!=e.peer&&a.send({type:"message",data:{author:this.peers[e.peer].username,message:s.data.message,id:e.peer}})});break}}),window.onunload=window.onbeforeunload=()=>{e.close()}})}send(t){this.emit("message",{author:this.username,message:t,id:this.id,me:!0}),Object.values(this.peers).map(r=>r.conn).forEach(r=>{r.send({type:"message",data:{author:this.username,message:t,id:this.id}})})}replaceStream(t){let r=t.getVideoTracks()[0];this.stream.getVideoTracks().forEach(e=>{e.stop(),this.stream.removeTrack(e)}),this.stream.addTrack(r),Object.values(this.peers).map(e=>e.media).forEach(e=>{e.peerConnection.getSenders().filter(s=>s.track.kind=="video").forEach(s=>s.replaceTrack(r))})}}export{o as default};
