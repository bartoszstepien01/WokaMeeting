import{e as r,P as h}from"./index-243eeab3.js";import"./vendor-775b6d8d.js";class p extends r.exports.EventEmitter{constructor(i,s,a){super();this.peers={},this.videoEnabled=!0,this.audioEnabled=!0,this.username=i,this.stream=s,this.peer=new h(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}),this.peer.on("open",t=>{this.id=t,this.emit("open",t);let o=this.peer.call(a,s,{metadata:{username:i,video:this.videoEnabled,audio:this.audioEnabled}});this.peers[a]={username:"",media:o},o.on("stream",e=>{this.hostStream=e}),this.hostConnection=this.peer.connect(a,{metadata:{username:i,video:this.videoEnabled,audio:this.audioEnabled}}),this.hostConnection.on("data",e=>{switch(e.type){case"connect":let n=this.peer.call(e.data.peerId,s,{metadata:{username:i,video:this.videoEnabled,audio:this.audioEnabled}});this.peers[e.data.peerId]={username:e.data.username,media:n},n.on("stream",d=>{this.emit("peer",{id:n.peer,username:e.data.username,stream:d,video:this.videoEnabled,audio:this.audioEnabled})});break;case"disconnect":delete this.peers[e.data.peerId],this.emit("disconnect",e.data.peerId);break;case"initialization":this.peers[this.hostConnection.peer].username=e.data.username,this.emit("peer",{id:this.hostConnection.peer,username:e.data.username,stream:this.hostStream,video:e.data.video,audio:e.data.audio});break;case"message":this.emit("message",{author:e.data.author,message:e.data.message,id:e.data.id,me:!1});break;case"toggle":this.emit("toggle",{id:e.data.id,video:e.data.video,audio:e.data.audio});break}}),this.hostConnection.on("close",()=>{delete this.peers[this.hostConnection.peer],this.emit("disconnect",this.hostConnection.peer)})}),this.peer.on("call",t=>{this.peers[t.peer]={username:t.metadata.username,media:t},t.answer(s),t.on("stream",o=>{this.emit("peer",{id:t.peer,username:t.metadata.username,stream:o,video:this.videoEnabled,audio:this.audioEnabled})})}),this.peer.on("connection",t=>t.close()),window.onunload=window.onbeforeunload=()=>{this.hostConnection.close()}}send(i){this.emit("message",{author:this.username,message:i,id:this.id,me:!0}),this.hostConnection.send({type:"message",data:{message:i}})}replaceStream(i){let s=i.getVideoTracks()[0];this.stream.getVideoTracks().forEach(a=>{a.stop(),this.stream.removeTrack(a)}),this.stream.addTrack(s),Object.values(this.peers).map(a=>a.media).forEach(a=>{a.peerConnection.getSenders().filter(t=>t.track.kind=="video").forEach(t=>t.replaceTrack(s))})}toggleMedia(i=this.videoEnabled,s=this.audioEnabled){this.videoEnabled=i,this.audioEnabled=s,this.hostConnection.send({type:"toggle",data:{id:this.peer.id,video:i,audio:s}})}}export{p as default};
