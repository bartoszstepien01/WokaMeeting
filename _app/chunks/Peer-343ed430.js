import{e as h,P as m}from"./index-f1a506a4.js";import"./vendor-ef7a3a0d.js";class u extends h.exports.EventEmitter{constructor(r,i,s){super();this.peers={},this.username=r,this.stream=i,this.peer=new m(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}),this.peer.on("open",e=>{this.id=e,this.emit("open",e);let a=this.peer.call(s,i,{metadata:{username:r}});this.peers[s]={username:"",media:a},a.on("stream",t=>{this.hostStream=t}),this.hostConnection=this.peer.connect(s,{metadata:{username:r}}),this.hostConnection.on("data",t=>{switch(t.type){case"connect":let n=this.peer.call(t.data.peerId,i,{metadata:{username:r}});this.peers[t.data.peerId]={username:t.data.username,media:n},n.on("stream",o=>{this.emit("peer",{id:n.peer,username:t.data.username,stream:o})});break;case"disconnect":delete this.peers[t.data.peerId],this.emit("disconnect",t.data.peerId);break;case"username":this.peers[this.hostConnection.peer].username=t.data.username,this.emit("peer",{id:this.hostConnection.peer,username:t.data.username,stream:this.hostStream});break;case"message":this.emit("message",{author:t.data.author,message:t.data.message,id:t.data.id,me:!1});break}}),this.hostConnection.on("close",()=>{delete this.peers[this.hostConnection.peer],this.emit("disconnect",this.hostConnection.peer)})}),this.peer.on("call",e=>{this.peers[e.peer]={username:e.metadata.username,media:e},e.answer(i),e.on("stream",a=>{this.emit("peer",{id:e.peer,username:e.metadata.username,stream:a})})}),this.peer.on("connection",e=>e.close()),window.onunload=window.onbeforeunload=()=>{this.hostConnection.close()}}send(r){this.emit("message",{author:this.username,message:r,id:this.id,me:!0}),this.hostConnection.send({type:"message",data:{message:r}})}replaceStream(r){let i=r.getVideoTracks()[0];this.stream.getVideoTracks().forEach(s=>{s.stop(),this.stream.removeTrack(s)}),this.stream.addTrack(i),Object.values(this.peers).map(s=>s.media).forEach(s=>{s.peerConnection.getSenders().filter(e=>e.track.kind=="video").forEach(e=>e.replaceTrack(i))})}}export{u as default};
