import{P as E}from"./peerjs.min-3f0f69c5.js";import"./vendor-ef7a3a0d.js";var b={exports:{}};(function(w){var l=Object.prototype.hasOwnProperty,i="~";function e(){}Object.create&&(e.prototype=Object.create(null),new e().__proto__||(i=!1));function p(a,r,s){this.fn=a,this.context=r,this.once=s||!1}function v(a,r,s,n,c){if(typeof s!="function")throw new TypeError("The listener must be a function");var h=new p(s,n||a,c),o=i?i+r:r;return a._events[o]?a._events[o].fn?a._events[o]=[a._events[o],h]:a._events[o].push(h):(a._events[o]=h,a._eventsCount++),a}function _(a,r){--a._eventsCount==0?a._events=new e:delete a._events[r]}function f(){this._events=new e,this._eventsCount=0}f.prototype.eventNames=function(){var r=[],s,n;if(this._eventsCount===0)return r;for(n in s=this._events)l.call(s,n)&&r.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(s)):r},f.prototype.listeners=function(r){var s=i?i+r:r,n=this._events[s];if(!n)return[];if(n.fn)return[n.fn];for(var c=0,h=n.length,o=new Array(h);c<h;c++)o[c]=n[c].fn;return o},f.prototype.listenerCount=function(r){var s=i?i+r:r,n=this._events[s];return n?n.fn?1:n.length:0},f.prototype.emit=function(r,s,n,c,h,o){var m=i?i+r:r;if(!this._events[m])return!1;var t=this._events[m],d=arguments.length,y,u;if(t.fn){switch(t.once&&this.removeListener(r,t.fn,void 0,!0),d){case 1:return t.fn.call(t.context),!0;case 2:return t.fn.call(t.context,s),!0;case 3:return t.fn.call(t.context,s,n),!0;case 4:return t.fn.call(t.context,s,n,c),!0;case 5:return t.fn.call(t.context,s,n,c,h),!0;case 6:return t.fn.call(t.context,s,n,c,h,o),!0}for(u=1,y=new Array(d-1);u<d;u++)y[u-1]=arguments[u];t.fn.apply(t.context,y)}else{var x=t.length,g;for(u=0;u<x;u++)switch(t[u].once&&this.removeListener(r,t[u].fn,void 0,!0),d){case 1:t[u].fn.call(t[u].context);break;case 2:t[u].fn.call(t[u].context,s);break;case 3:t[u].fn.call(t[u].context,s,n);break;case 4:t[u].fn.call(t[u].context,s,n,c);break;default:if(!y)for(g=1,y=new Array(d-1);g<d;g++)y[g-1]=arguments[g];t[u].fn.apply(t[u].context,y)}}return!0},f.prototype.on=function(r,s,n){return v(this,r,s,n,!1)},f.prototype.once=function(r,s,n){return v(this,r,s,n,!0)},f.prototype.removeListener=function(r,s,n,c){var h=i?i+r:r;if(!this._events[h])return this;if(!s)return _(this,h),this;var o=this._events[h];if(o.fn)o.fn===s&&(!c||o.once)&&(!n||o.context===n)&&_(this,h);else{for(var m=0,t=[],d=o.length;m<d;m++)(o[m].fn!==s||c&&!o[m].once||n&&o[m].context!==n)&&t.push(o[m]);t.length?this._events[h]=t.length===1?t[0]:t:_(this,h)}return this},f.prototype.removeAllListeners=function(r){var s;return r?(s=i?i+r:r,this._events[s]&&_(this,s)):(this._events=new e,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=i,f.EventEmitter=f,w.exports=f})(b);class j extends b.exports.EventEmitter{constructor(l,i){super();this.peers={},this.username=l,this.stream=i,this.peer=new E(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}),this.peer.on("open",e=>{this.id=e,this.emit("open",e)}),this.peer.on("call",e=>{e.peer in this.peers?this.peers[e.peer].media=e:this.peers[e.peer]={username:e.metadata.username,media:e,conn:void 0},e.answer(i),e.on("stream",p=>{this.emit("peer",{id:e.peer,username:e.metadata.username,stream:p})})}),this.peer.on("connection",e=>{e.peer in this.peers?this.peers[e.peer].conn=e:this.peers[e.peer]={username:e.metadata.username,media:void 0,conn:e},e.on("open",()=>{Object.values(this.peers).map(p=>p.conn).forEach(p=>{p.peer!=e.peer&&p.send({type:"connect",data:{peerId:e.peer,username:this.peers[e.peer].username}})}),e.send({type:"username",data:{username:l}})}),e.on("close",()=>{delete this.peers[e.peer],Object.values(this.peers).map(p=>p.conn).forEach(p=>{p.send({type:"disconnect",data:{peerId:e.peer}})}),this.emit("disconnect",e.peer)}),e.on("data",p=>{switch(p.type){case"message":this.emit("message",{author:this.peers[e.peer].username,message:p.data.message,id:e.peer,me:!1}),Object.values(this.peers).map(v=>v.conn).forEach(v=>{v.peer!=e.peer&&v.send({type:"message",data:{author:this.peers[e.peer].username,message:p.data.message,id:e.peer}})});break}}),window.onunload=window.onbeforeunload=()=>{e.close()}})}send(l){this.emit("message",{author:this.username,message:l,id:this.id,me:!0}),Object.values(this.peers).map(i=>i.conn).forEach(i=>{i.send({type:"message",data:{author:this.username,message:l,id:this.id}})})}replaceStream(l){let i=l.getVideoTracks()[0];this.stream.getVideoTracks().forEach(e=>{e.stop(),this.stream.removeTrack(e)}),this.stream.addTrack(i),Object.values(this.peers).map(e=>e.media).forEach(e=>{e.peerConnection.getSenders().filter(p=>p.track.kind=="video").forEach(p=>p.replaceTrack(i))})}}export{j as default};
