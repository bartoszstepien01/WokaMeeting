var c=Object.defineProperty;var u=(d,n,t)=>n in d?c(d,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[n]=t;var o=(d,n,t)=>(u(d,typeof n!="symbol"?n+"":n,t),t);import{e as p,$ as l,P as E,a as b,b as v}from"./public.c29bcb9f.js";class k extends p.EventEmitter{constructor(t,s,a){super();o(this,"peer");o(this,"peers",{});o(this,"hostStream");o(this,"hostConnection");o(this,"username");o(this,"id");o(this,"stream");o(this,"videoEnabled",!0);o(this,"audioEnabled",!0);this.username=t,this.stream=s,this.peer=new l(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:E,credential:b,username:v}]}}),this.peer.on("open",i=>{this.id=i,this.emit("open",i);let r=this.peer.call(a,s,{metadata:{username:t,video:this.videoEnabled,audio:this.audioEnabled}});this.peers[a]={username:"",media:r},r.on("stream",e=>{this.hostStream=e}),this.hostConnection=this.peer.connect(a,{metadata:{username:t,video:this.videoEnabled,audio:this.audioEnabled}}),this.hostConnection.on("data",e=>{switch(e.type){case"connect":let h=this.peer.call(e.data.peerId,s,{metadata:{username:t,video:this.videoEnabled,audio:this.audioEnabled}});this.peers[e.data.peerId]={username:e.data.username,media:h},h.on("stream",m=>{this.emit("peer",{id:h.peer,username:e.data.username,stream:m,video:this.videoEnabled,audio:this.audioEnabled})});break;case"disconnect":delete this.peers[e.data.peerId],this.emit("disconnect",e.data.peerId);break;case"initialization":this.peers[this.hostConnection.peer].username=e.data.username,this.emit("peer",{id:this.hostConnection.peer,username:e.data.username,stream:this.hostStream,video:e.data.video,audio:e.data.audio});break;case"message":this.emit("message",{author:e.data.author,message:e.data.message,id:e.data.id,me:!1});break;case"toggle":this.emit("toggle",{id:e.data.id,video:e.data.video,audio:e.data.audio});break}}),this.hostConnection.on("close",()=>{delete this.peers[this.hostConnection.peer],this.emit("disconnect",this.hostConnection.peer)})}),this.peer.on("call",i=>{this.peers[i.peer]={username:i.metadata.username,media:i},i.answer(s),i.on("stream",r=>{this.emit("peer",{id:i.peer,username:i.metadata.username,stream:r,video:this.videoEnabled,audio:this.audioEnabled})})}),this.peer.on("connection",i=>i.close()),window.onunload=window.onbeforeunload=()=>{this.hostConnection.close()}}send(t){this.emit("message",{author:this.username,message:t,id:this.id,me:!0}),this.hostConnection.send({type:"message",data:{message:t}})}replaceStream(t){let s=t.getVideoTracks()[0];this.stream.getVideoTracks().forEach(a=>{a.stop(),this.stream.removeTrack(a)}),this.stream.addTrack(s),Object.values(this.peers).map(a=>a.media).forEach(a=>{a.peerConnection.getSenders().filter(i=>i.track.kind=="video").forEach(i=>i.replaceTrack(s))})}toggleMedia(t=this.videoEnabled,s=this.audioEnabled){this.videoEnabled=t,this.audioEnabled=s,this.hostConnection&&this.hostConnection.send({type:"toggle",data:{id:this.peer.id,video:t,audio:s}})}}export{k as default};
