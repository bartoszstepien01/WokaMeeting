var o=Object.defineProperty;var m=(p,i,t)=>i in p?o(p,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[i]=t;var d=(p,i,t)=>(m(p,typeof i!="symbol"?i+"":i,t),t);import{e as h,$ as u}from"./index.fda93153.js";class v extends h.EventEmitter{constructor(t,a){super();d(this,"peer");d(this,"peers",{});d(this,"username");d(this,"id");d(this,"stream");d(this,"videoEnabled",!0);d(this,"audioEnabled",!0);this.username=t,this.stream=a,this.peer=new u(void 0,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:{}.TURN_SERVER,credential:{}.TURN_CREDENTIAL,username:{}.TURN_USERNAME}]}}),this.peer.on("open",e=>{this.id=e,this.emit("open",e)}),this.peer.on("call",e=>{e.peer in this.peers?this.peers[e.peer].media=e:this.peers[e.peer]={username:e.metadata.username,media:e,conn:void 0},e.answer(a),e.on("stream",s=>{this.emit("peer",{id:e.peer,username:e.metadata.username,stream:s,video:e.metadata.video,audio:e.metadata.audio})})}),this.peer.on("connection",e=>{e.peer in this.peers?this.peers[e.peer].conn=e:this.peers[e.peer]={username:e.metadata.username,media:void 0,conn:e},e.on("open",()=>{Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.peer!=e.peer&&s.send({type:"connect",data:{peerId:e.peer,username:this.peers[e.peer].username}})}),e.send({type:"initialization",data:{username:t,video:this.videoEnabled,audio:this.audioEnabled}})}),e.on("close",()=>{delete this.peers[e.peer],Object.values(this.peers).map(s=>s.conn).forEach(s=>{s.send({type:"disconnect",data:{peerId:e.peer}})}),this.emit("disconnect",e.peer)}),e.on("data",s=>{switch(s.type){case"message":this.emit("message",{author:this.peers[e.peer].username,message:s.data.message,id:e.peer,me:!1}),Object.values(this.peers).map(r=>r.conn).forEach(r=>{r.peer!=e.peer&&r.send({type:"message",data:{author:this.peers[e.peer].username,message:s.data.message,id:e.peer}})});break;case"toggle":this.emit("toggle",{id:e.peer,video:s.data.video,audio:s.data.audio}),Object.values(this.peers).map(r=>r.conn).forEach(r=>{r.peer!=e.peer&&r.send({type:"toggle",data:{id:e.peer,video:s.data.video,audio:s.data.audio}})});break}}),window.onunload=window.onbeforeunload=()=>{e.close()}})}send(t){this.emit("message",{author:this.username,message:t,id:this.id,me:!0}),Object.values(this.peers).map(a=>a.conn).forEach(a=>{a.send({type:"message",data:{author:this.username,message:t,id:this.id}})})}replaceStream(t){let a=t.getVideoTracks()[0];this.stream.getVideoTracks().forEach(e=>{e.stop(),this.stream.removeTrack(e)}),this.stream.addTrack(a),Object.values(this.peers).map(e=>e.media).forEach(e=>{e.peerConnection.getSenders().filter(s=>s.track.kind=="video").forEach(s=>s.replaceTrack(a))})}toggleMedia(t=this.videoEnabled,a=this.audioEnabled){this.videoEnabled=t,this.audioEnabled=a,Object.values(this.peers).map(e=>e.conn).forEach(e=>{e.send({type:"toggle",data:{id:this.peer.id,video:t,audio:a}})})}}export{v as default};
